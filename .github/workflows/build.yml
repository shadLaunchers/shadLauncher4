# SPDX-FileCopyrightText: 2025 shadLauncher4 Emulator Project
# SPDX-License-Identifier: GPL-2.0-or-later

name: Build and Release

on: [push, pull_request]

concurrency:
  group: ci-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

env:
  BUILD_TYPE: Release

jobs:
  reuse:
    runs-on: ubuntu-24.04
    continue-on-error: true
    steps:
      - uses: actions/checkout@v5
      - uses: fsfe/reuse-action@v5

  clang-format:
    runs-on: ubuntu-24.04
    continue-on-error: true
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install clang-format
        run: |
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository 'deb http://apt.llvm.org/noble/ llvm-toolchain-noble-19 main'
          sudo apt update
          sudo apt install -y clang-format-19

      - name: Run clang-format check
        env:
          COMMIT_RANGE: ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}
        run: ./.ci/clang-format.sh

  get-info:
    runs-on: ubuntu-24.04
    outputs:
      date: ${{ steps.vars.outputs.date }}
      shorthash: ${{ steps.vars.outputs.shorthash }}
      fullhash: ${{ steps.vars.outputs.fullhash }}
    steps:
      - uses: actions/checkout@v5

      - name: Get date and git hash
        id: vars
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "shorthash=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "fullhash=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "shorthash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "fullhash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  windows-qt:
    runs-on: windows-2025
    needs: get-info
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Enable MSVC dev environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Setup Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: 6.10.0
          host: windows
          target: desktop
          arch: win64_msvc2022_64
          archives: qtbase qttools
          modules: qtmultimedia

      - name: Run version script
        shell: bash
        run: .github/workflows/scripts/update_version.sh

      - name: Read computed version
        shell: pwsh
        run: |
          $path = Join-Path $env:GITHUB_WORKSPACE "version.txt"
          if (-not (Test-Path $path)) {
            Write-Error "version.txt not found at $path"
            exit 1
          }
          $version = (Get-Content -Path $path -Raw).Trim()
          Write-Host "Setting APP_VERSION=$version"
          echo "APP_VERSION=$version" >> $env:GITHUB_ENV

      - name: Cache CMake Configuration
        uses: actions/cache@v4
        env:
          cache-name: ${{ runner.os }}-qt-ninja-cache-cmake-configuration
        with:
          path: ${{ github.workspace }}/build
          key: ${{ env.cache-name }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}
          restore-keys: |
            ${{ env.cache-name }}-

      - name: Cache CMake Build
        uses: hendrikmuhs/ccache-action@v1.2.19
        env:
          cache-name: ${{ runner.os }}-qt-cache-cmake-build
        with:
          append-timestamp: false
          key: ${{ env.cache-name }}-${{ hashFiles('**/CMakeLists.txt', 'cmake/**') }}

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake --fresh -G Ninja `
            -B "${{ github.workspace }}/build" `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DAPP_VERSION="${{ env.APP_VERSION }}" `
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION_RELEASE=ON `
            -DCMAKE_C_COMPILER=clang-cl `
            -DCMAKE_CXX_COMPILER=clang-cl `
            -DCMAKE_C_COMPILER_LAUNCHER=ccache `
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache `
            -DENABLE_UPDATER=ON

      - name: Build
        run: cmake --build ${{ github.workspace }}/build --config ${{ env.BUILD_TYPE }} --parallel $env:NUMBER_OF_PROCESSORS

      - name: Deploy and Package
        shell: pwsh
        run: |
          mkdir upload
          mkdir upload/qtplugins
          move build/shadLauncher4.exe upload
          cp dist/qt.conf upload/qt.conf
          windeployqt --plugindir upload/qtplugins --no-compiler-runtime --no-system-d3d-compiler --no-system-dxc-compiler --dir upload upload/shadLauncher4.exe
          Compress-Archive -Path upload/* -DestinationPath shadLauncher4-win64-qt-${{ needs.get-info.outputs.date }}-${{ needs.get-info.outputs.shorthash }}.zip

      - name: Upload Windows Qt artifact
        uses: actions/upload-artifact@v4
        with:
          name: shadLauncher4-win64-qt-${{ needs.get-info.outputs.date }}-${{ needs.get-info.outputs.shorthash }}
          path: shadLauncher4-win64-qt-*.zip

  pre-release:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [get-info, windows-qt]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts

      - name: Create pre-release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.SHADLAUNCHER4_TOKEN_REPO }}
          name: shadLauncher4 ${{ needs.get-info.outputs.date }} (${{ needs.get-info.outputs.shorthash }})
          tag: shadLauncher4-${{ needs.get-info.outputs.date }}-${{ needs.get-info.outputs.fullhash }}
          prerelease: true
          body: "Auto-generated release for the latest commit to main."
          artifacts: artifacts/**/*.zip

      - name: Get current pre-release date
        env:
          SHADLAUNCHER4_TOKEN_REPO: ${{ secrets.SHADLAUNCHER4_TOKEN_REPO }}
        run: |
          releases=$(curl -s -H "Authorization: token $SHADLAUNCHER4_TOKEN_REPO" https://api.github.com/repos/${{ github.repository }}/releases)
          current=$(echo "$releases" | jq -r '.[] | select(.prerelease==true) | .published_at' | sort -r | head -n1)
          echo "CURRENT_PUBLISHED_AT=$current" >> $GITHUB_ENV

      - name: Delete old pre-releases and tags
        env:
          SHADLAUNCHER4_TOKEN_REPO: ${{ secrets.SHADLAUNCHER4_TOKEN_REPO }}
        run: |
          releases=$(curl -s -H "Authorization: token $SHADLAUNCHER4_TOKEN_REPO" https://api.github.com/repos/${{ github.repository }}/releases)
          current_ts=$(date -d "$CURRENT_PUBLISHED_AT" +%s)

          echo "$releases" | jq -c '.[] | select(.prerelease==true)' | while read r; do
            release_ts=$(date -d "$(echo $r | jq -r .published_at)" +%s)
            if [ "$release_ts" -lt "$current_ts" ]; then
              id=$(echo $r | jq -r .id)
              tag=$(echo $r | jq -r .tag_name)
              curl -X DELETE -H "Authorization: token $SHADLAUNCHER4_TOKEN_REPO" https://api.github.com/repos/${{ github.repository }}/releases/$id
              curl -X DELETE -H "Authorization: token $SHADLAUNCHER4_TOKEN_REPO" https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$tag
            fi
          done
